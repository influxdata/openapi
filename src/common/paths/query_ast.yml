post:
  operationId: PostQueryAst
  tags:
    - Query
  summary: Generate an Abstract Syntax Tree (AST) from a Flux query
  description: |
    Analyzes a Flux query and generates a complete package source AST from the
    query.

    ASTs are tree representations of the syntax in the Flux language's source code.
    The generated response from this endpoint provides a semantic representation
    of the Flux query with contextual information. The AST breaks down how the
    query is distributed into different components for execution.

    Use this endpoint for deep query analysis such as debugging unexpected query
    results.

    #### Limitations 

    -  The endpoint doesn't validate values in the query--for example:

        The following query has correct syntax, but contains an incorrect `from()` property key:
        ```json
        { "query": "from(foo: \"iot_center\")\
                    |> range(start: -90d)\
                    |> filter(fn: (r) => r._measurement == \"environment\")"
        }
        ```
        Passing this to `/api/v2/query/ast` will return a successful response
        with a generated AST.

  parameters:
    - $ref: "../parameters/TraceSpan.yml"
    - in: header
      name: Content-Type
      schema:
        type: string
        enum:
          - application/json
  requestBody:
    description: Analyzed Flux query to generate an AST.
    content:
      application/json:
        schema:
          $ref: "../schemas/LanguageRequest.yml"
  x-codeSamples:
    - lang: Shell
      label: cURL
      source: |
        curl --request POST 'INFLUX_URL/api/v2/query/ast' \
        --header 'Content-Type: application/json' \
        --header 'Accept: application/json \
        --header 'Authorization: Token INFLUX_TOKEN' \
        --data 'from(bucket: "example-bucket")
                  |> range(start: -5m)
                  |> filter(fn: (r) => r._measurement == "example-measurement")'
  responses:
    "200":
      description: |
        Successful request.
        AST of the Flux query.
      content:
        application/json:
          schema:
            $ref: "../schemas/ASTResponse.yml"
          examples:
            $ref: "../schemas/ASTSuccessResponse.yml"
    "400":
      description: |
        Bad request.
        InfluxDB is unable to parse the request.
        The response body contains detail about the problem.
      headers:
        X-Platform-Error-Code:
          description: |
            The reason for the error.
          schema:
            type: string
            example: "invalid"
      content:
        application/json:
          schema:
            $ref: "../schemas/Error.yml"
          examples:
            invalidASTValue:
              summary: Invalid AST
              value: {
                  "code": "invalid",
                  "message": "invalid AST: loc 1:6-1:19: missing property key"
                }
    default:
      description: Any response other than 200 is an internal server error.
      content:
        application/json:
          schema:
            $ref: "../schemas/Error.yml"
